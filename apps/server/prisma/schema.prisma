generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// User Management
// ============================================

model User {
  id            String   @id @default(uuid())
  walletAddress String   @unique @map("wallet_address")
  createdAt     DateTime @default(now()) @map("created_at")
  lastLogin     DateTime? @map("last_login")

  // Relations
  wallets       Wallet[]
  sniperConfigs SniperConfig[]
  positions     Position[]
  transactions  Transaction[]
  activityLogs  ActivityLog[]
  auditLogs     AuditLog[]

  @@map("users")
}

// ============================================
// Wallet Management
// ============================================

model Wallet {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  publicKey String   @unique @map("public_key")
  walletType String  @map("wallet_type") // 'connected' | 'generated'
  label     String?
  isPrimary Boolean  @default(false) @map("is_primary")
  isActive  Boolean  @default(true) @map("is_active")

  // Encrypted private key (for generated wallets only)
  encryptedPrivateKey String? @map("encrypted_private_key")
  iv                  String?
  authTag             String? @map("auth_tag")
  keyVersion          Int?    @default(1) @map("key_version")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  sniperConfigs SniperConfig[]
  positions     Position[]

  @@index([userId])
  @@map("wallets")
}

// ============================================
// Sniper Configuration
// ============================================

model SniperConfig {
  id       String  @id @default(uuid())
  userId   String  @map("user_id")
  walletId String  @map("wallet_id")
  name     String
  isActive Boolean @default(false) @map("is_active")

  // Flexible JSON configuration for sniper parameters
  // Allows easy addition of new parameters without schema changes
  config Json

  // Stats
  totalSnipes      Int   @default(0) @map("total_snipes")
  successfulSnipes Int   @default(0) @map("successful_snipes")
  failedSnipes     Int   @default(0) @map("failed_snipes")
  totalSolSpent    Float @default(0) @map("total_sol_spent")
  tokensFiltered   Int   @default(0) @map("tokens_filtered")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  // Relations
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  wallet    Wallet     @relation(fields: [walletId], references: [id])
  positions Position[]

  @@index([userId])
  @@index([isActive])
  @@map("sniper_configs")
}

// ============================================
// Trading Positions
// ============================================

model Position {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  walletId    String   @map("wallet_id")
  sniperId    String?  @map("sniper_id")

  // Token information
  tokenMint   String   @map("token_mint")
  tokenSymbol String?  @map("token_symbol")
  tokenName   String?  @map("token_name")

  // Entry details
  entryPrice       Float    @map("entry_price")
  entryTokenAmount Float    @map("entry_token_amount") // Token amount
  entrySol         Float    @map("entry_sol")    // SOL spent

  // Current state
  currentTokenAmount Float  @map("current_token_amount")
  status        String @default("open") // 'open' | 'closed' | 'liquidated'

  // Automation targets (snapshot from sniper config at entry)
  takeProfitPrice  Float?  @map("take_profit_price")
  stopLossPrice    Float?  @map("stop_loss_price")
  trailingStopPct  Float?  @map("trailing_stop_pct")
  highestPrice     Float?  @map("highest_price") // For trailing stop

  // Exit details
  exitPrice    Float?  @map("exit_price")
  exitSol      Float?  @map("exit_sol")

  createdAt    DateTime  @default(now()) @map("created_at")
  closedAt     DateTime? @map("closed_at")

  // Relations
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  wallet       Wallet        @relation(fields: [walletId], references: [id])
  sniper       SniperConfig? @relation(fields: [sniperId], references: [id], onDelete: SetNull)
  transactions Transaction[]

  @@index([userId, status])
  @@index([tokenMint])
  @@index([sniperId])
  @@map("positions")
}

// ============================================
// Transactions
// ============================================

model Transaction {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  positionId  String?  @map("position_id")

  // Transaction details
  signature   String   @unique
  txType      String   @map("tx_type") // 'buy' | 'sell' | 'take_profit' | 'stop_loss'
  tokenMint   String?  @map("token_mint")

  // Amounts
  solAmount   Float    @map("sol_amount")
  tokenAmount Float    @map("token_amount")
  pricePerToken Float? @map("price_per_token")

  // Fees
  platformFee Float    @map("platform_fee")
  jitoTip     Float?   @map("jito_tip")
  networkFee  Float?   @map("network_fee")

  // Execution details
  slippageBps   Int?    @map("slippage_bps")
  bundleId      String? @map("bundle_id")
  executionTime Int?    @map("execution_time_ms")

  // Status
  status       String   @default("pending") // 'pending' | 'confirmed' | 'failed'
  errorMessage String?  @map("error_message")

  createdAt   DateTime  @default(now()) @map("created_at")
  confirmedAt DateTime? @map("confirmed_at")

  // Relations
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  position Position? @relation(fields: [positionId], references: [id], onDelete: SetNull)
  feeLedger FeeLedger?

  @@index([userId])
  @@index([status])
  @@map("transactions")
}

// ============================================
// Fee Tracking
// ============================================

model FeeLedger {
  id            String   @id @default(uuid())
  transactionId String?  @unique @map("transaction_id")
  userId        String   @map("user_id")

  feeType       String?  @map("fee_type") // 'trade_fee' | 'withdrawal_fee'
  feeAmount     Float    @map("fee_amount")
  feeSol        Float?   @map("fee_sol")

  // Settlement tracking
  settled          Boolean   @default(false)
  settledSignature String?   @map("settled_signature")
  settledAt        DateTime? @map("settled_at")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  transaction Transaction? @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@index([settled])
  @@map("fee_ledger")
}

// ============================================
// Activity & Audit Logging
// ============================================

model ActivityLog {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  sniperId  String?  @map("sniper_id")

  eventType String   @map("event_type")
  eventData Json     @map("event_data")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("activity_log")
}

model AuditLog {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  action       String   // e.g., 'PRIVATE_KEY_EXPORTED', 'LOGIN', 'SNIPER_CREATED'
  resourceType String?  @map("resource_type")
  resourceId   String?  @map("resource_id")
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  metadata     Json?

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@map("audit_log")
}

// ============================================
// Migration Events (for analytics/debugging)
// ============================================

model MigrationEvent {
  id        String   @id @default(uuid())

  // Token info
  tokenMint   String  @map("token_mint")
  tokenName   String? @map("token_name")
  tokenSymbol String? @map("token_symbol")

  // Migration details
  bondingCurveAddress String? @map("bonding_curve_address")
  poolAddress         String? @map("pool_address")
  initialLiquiditySol Float?  @map("initial_liquidity_sol")
  initialPriceSol     Float?  @map("initial_price_sol")
  initialMarketCapUsd Float?  @map("initial_market_cap_usd")

  // Detection metadata
  detectedAt     DateTime @default(now()) @map("detected_at")
  source         String   // 'pumpportal' | 'helius' | 'raydium'
  detectionLatencyMs Int? @map("detection_latency_ms")

  // Snipe results
  totalSnipesAttempted  Int @default(0) @map("total_snipes_attempted")
  totalSnipesSuccessful Int @default(0) @map("total_snipes_successful")

  // Price performance tracking
  highestPriceSol     Float?   @map("highest_price_sol")
  highestMarketCapUsd Float?   @map("highest_market_cap_usd")
  highestPriceAt      DateTime? @map("highest_price_at")

  // Milestone achievements (when price first hit these multipliers)
  reached2x           Boolean  @default(false) @map("reached_2x")
  reached2xAt         DateTime? @map("reached_2x_at")
  reached5x           Boolean  @default(false) @map("reached_5x")
  reached5xAt         DateTime? @map("reached_5x_at")
  reached10x          Boolean  @default(false) @map("reached_10x")
  reached10xAt        DateTime? @map("reached_10x_at")
  reached50x          Boolean  @default(false) @map("reached_50x")
  reached50xAt        DateTime? @map("reached_50x_at")
  reached100x         Boolean  @default(false) @map("reached_100x")
  reached100xAt       DateTime? @map("reached_100x_at")

  // Current status
  lastPriceCheck      DateTime? @map("last_price_check")
  currentPriceSol     Float?    @map("current_price_sol")
  isRugged            Boolean   @default(false) @map("is_rugged")

  // Volume and legitimacy metrics (for filtering fake/botted tokens)
  volumeUsd24h        Float?    @map("volume_usd_24h")
  volumeUsdTotal      Float?    @map("volume_usd_total")
  txCount24h          Int?      @map("tx_count_24h")
  holderCount         Int?      @map("holder_count")
  buyTxCount24h       Int?      @map("buy_tx_count_24h")
  sellTxCount24h      Int?      @map("sell_tx_count_24h")
  lastVolumeUpdate    DateTime? @map("last_volume_update")
  isVerified          Boolean   @default(false) @map("is_verified") // Manually verified as legitimate

  @@index([tokenMint])
  @@index([detectedAt])
  @@index([reached2x])
  @@index([reached5x])
  @@index([reached10x])
  @@map("migration_events")
}

// ============================================
// Platform Statistics (aggregated metrics)
// ============================================

model PlatformStats {
  id        String   @id @default(uuid())

  // Time period
  periodType  String   @map("period_type") // 'all_time' | 'daily' | 'weekly' | 'monthly'
  periodStart DateTime @map("period_start")
  periodEnd   DateTime @map("period_end")

  // Migration counts
  totalMigrations     Int @default(0) @map("total_migrations")
  migrationsTracked   Int @default(0) @map("migrations_tracked")

  // Performance percentages
  pctReached2x   Float @default(0) @map("pct_reached_2x")
  pctReached5x   Float @default(0) @map("pct_reached_5x")
  pctReached10x  Float @default(0) @map("pct_reached_10x")
  pctReached50x  Float @default(0) @map("pct_reached_50x")
  pctReached100x Float @default(0) @map("pct_reached_100x")

  // Top performers
  highestMultiplier     Float?  @map("highest_multiplier")
  highestMultiplierMint String? @map("highest_multiplier_mint")
  highestMarketCapUsd   Float?  @map("highest_market_cap_usd")
  highestMarketCapMint  String? @map("highest_market_cap_mint")

  // Platform performance
  totalSnipesExecuted   Int   @default(0) @map("total_snipes_executed")
  avgSnipeLatencyMs     Float @default(0) @map("avg_snipe_latency_ms")
  totalSolTraded        Float @default(0) @map("total_sol_traded")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  @@unique([periodType, periodStart])
  @@index([periodType])
  @@map("platform_stats")
}
